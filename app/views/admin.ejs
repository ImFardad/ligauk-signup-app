<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>پنل ادمین</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .content-section { opacity:0; display:none; transition:opacity .3s ease }
    .content-section.active { display:block; opacity:1 }
    .fade-in  { opacity:1!important }
    .fade-out { opacity:0!important }
    .alert-box { display:flex; align-items:center; padding:10px; border-radius:5px; margin-bottom:10px; opacity:0; transition:opacity .5s ease-out }
    .alert-box.show { opacity:1 }
    
    .compact-table th, .compact-table td {
        padding: 4px 6px;
        font-size: 0.8rem;
        white-space: nowrap;
    }
    .compact-table .input-field {
        font-size: 0.8rem;
        padding: 3px 5px;
    }
    .compact-table .btn-primary, .compact-table .btn-secondary {
        padding: 2px 8px !important;
        font-size: 0.75rem;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        overflow-y: auto;
    }
    .modal-content {
        background-color: #2d3748; /* bg-gray-800 */
        padding: 1.5rem;
        border-radius: 0.5rem;
        width: 50%;
        max-width: 800px;
        margin-top: 2rem;
        margin-bottom: 2rem;
    }
  </style>
</head>
<body class="bg-pattern min-h-screen p-4 relative">

  <div class="flex justify-end space-x-2 mb-4">
    <button id="refresh-btn" class="text-gray-300 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">رفرش</button>
    <a href="/logout" class="text-gray-300 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">خروج</a>
  </div>

  <div id="alert-container" class="fixed top-4 right-4 z-50 w-96"></div>
  <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-40">
    <div class="w-16 h-16 border-t-4 border-blue-500 rounded-full animate-spin"></div>
  </div>

  <div id="adminApp" class="bg-gray-800 bg-opacity-50 backdrop-blur-lg p-6 rounded-2xl mx-auto mt-8 flex flex-wrap">

    <nav class="w-full md:w-1/5 text-white p-4 border-l border-gray-700 mb-6 md:mb-0">
      <ul>
        <li v-for="sec in sections" :key="sec.key"
            @click="selectSection(sec.key)"
            class="py-2 px-3 cursor-pointer rounded hover:bg-gray-700 transition-colors my-2"
            :class="{'bg-gray-700 font-bold': activeSection===sec.key}">
          {{ sec.label }}
        </li>
      </ul>
    </nav>

    <div class="w-full md:w-4/5 p-4 text-white overflow-x-auto">

      <section id="users" class="content-section" :class="{'active fade-in': activeSection==='users'}">
        <h2 class="text-2xl font-bold mb-4">مدیریت کاربران</h2>
        <input v-model="search" @input="fetchUsers" placeholder="جستجو…" class="input-field mb-4 w-full">
        <table class="min-w-full bg-gray-700 rounded overflow-hidden compact-table">
            <thead>
                <tr class="bg-gray-800 text-gray-300">
                  <th>#</th><th>نام</th><th>نام‌خانوادگی</th><th>جنسیت</th><th>موبایل</th><th>کد ملی</th><th>ایمیل</th><th>نقش</th><th>فعال</th><th>ذخیره</th><th>حذف</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(u, idx) in users" :key="u.id" class="border-b border-gray-600 hover:bg-gray-600">
                  <td class="text-center">{{ idx+1 }}</td>
                  <td><input v-model="u.firstName" class="input-field w-full"></td>
                  <td><input v-model="u.lastName"  class="input-field w-full"></td>
                  <td>
                    <select v-model="u.gender" class="input-field w-full">
                      <option value="male">مرد</option>
                      <option value="female">زن</option>
                    </select>
                  </td>
                  <td><input v-model="u.phoneNumber" class="input-field w-full"></td>
                  <td><input v-model="u.nationalId" class="input-field w-full"></td>
                  <td><input v-model="u.email" class="input-field w-full"></td>
                  <td>
                    <select v-model="u.role" class="input-field w-full">
                      <option value="user">کاربر</option>
                      <option value="mentor">منتور</option>
                    </select>
                  </td>
                  <td class="text-center"><input type="checkbox" v-model="u.isActive"></td>
                  <td class="text-center"><button class="btn-primary" @click="updateUser(u)">ذخیره</button></td>
                  <td class="text-center"><button class="btn-secondary" @click="deleteUser(u)">حذف</button></td>
                </tr>
              </tbody>
        </table>
      </section>

      <section id="mentors" class="content-section" :class="{'active fade-in': activeSection==='mentors'}">
        <h2 class="text-2xl font-bold mb-4">مدیریت منتورها</h2>
        <input v-model="searchMentor" @input="fetchMentors" placeholder="جستجو…" class="input-field mb-4 w-full">
        <table class="min-w-full bg-gray-700 rounded overflow-hidden compact-table">
            <thead>
                <tr class="bg-gray-800 text-gray-300">
                  <th>#</th><th>نام</th><th>نام‌خانوادگی</th><th>جنسیت</th><th>موبایل</th><th>کد ملی</th><th>ایمیل</th><th>نقش</th><th>فعال</th><th>ذخیره</th><th>حذف</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(u, idx) in mentors" :key="u.id" class="border-b border-gray-600 hover:bg-gray-600">
                  <td class="text-center">{{ idx+1 }}</td>
                  <td><input v-model="u.firstName" class="input-field w-full"></td>
                  <td><input v-model="u.lastName"  class="input-field w-full"></td>
                  <td>
                    <select v-model="u.gender" class="input-field w-full">
                      <option value="male">مرد</option>
                      <option value="female">زن</option>
                    </select>
                  </td>
                  <td><input v-model="u.phoneNumber" class="input-field w-full"></td>
                  <td><input v-model="u.nationalId" class="input-field w-full"></td>
                  <td><input v-model="u.email" class="input-field w-full"></td>
                  <td>
                    <select v-model="u.role" class="input-field w-full">
                      <option value="user">کاربر</option>
                      <option value="mentor">منتور</option>
                    </select>
                  </td>
                  <td class="text-center"><input type="checkbox" v-model="u.isActive"></td>
                  <td class="text-center"><button class="btn-primary" @click="updateUser(u)">ذخیره</button></td>
                  <td class="text-center"><button class="btn-secondary" @click="deleteUser(u)">حذف</button></td>
                </tr>
              </tbody>
        </table>
      </section>

      <section id="announcements" class="content-section" :class="{'active fade-in': activeSection==='announcements'}">
        <h2 class="text-2xl font-bold mb-4">مدیریت اطلاعیه‌ها</h2>
        <button @click="openCreateForm" class="btn-primary px-4 py-2 mb-4">ایجاد اطلاعیه جدید</button>
        <table class="min-w-full bg-gray-700 rounded overflow-hidden text-sm">
            <thead>
                <tr class="bg-gray-800 text-gray-300">
                  <th>#</th><th>عنوان</th><th>مختصر</th><th>تاریخ</th><th>ویرایش</th><th>حذف</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(a, idx) in announcements" :key="a.id" class="border-b border-gray-600 hover:bg-gray-600">
                  <td class="px-2 py-1 text-center">{{ idx+1 }}</td>
                  <td class="px-2">{{ a.title }}</td>
                  <td class="px-2">{{ a.shortDescription||'—' }}</td>
                  <td class="px-2">{{ new Date(a.createdAt).toLocaleDateString('fa-IR') }}</td>
                  <td class="px-2 text-center"><button class="btn-primary px-2 py-1" @click="openEditForm(a)">ویرایش</button></td>
                  <td class="px-2 text-center"><button class="btn-secondary px-2 py-1" @click="deleteAnnouncement(a)">حذف</button></td>
                </tr>
              </tbody>
        </table>
        <div v-if="showForm" class="modal-backdrop">
          <div class="modal-content">
            <h3 class="text-xl font-bold">{{ editingId ? 'ویرایش اطلاعیه' : 'ایجاد اطلاعیه جدید' }}</h3>
            <input v-model="form.title" placeholder="عنوان *" class="input-field w-full mt-4" />
            <input v-model="form.shortDescription" placeholder="مختصر" class="input-field w-full mt-2" />
            <textarea v-model="form.longDescription" placeholder="توضیح کامل" class="input-field w-full h-24 mt-2"></textarea>
            <div v-if="form.attachments.length">
                <p class="font-medium mt-4">ضمائم فعلی:</p>
                <ul class="space-y-2 mt-2">
                    <li v-for="att in form.attachments" :key="att.id" class="border border-gray-600 p-2 rounded flex justify-between items-center">
                        <a :href="att.path" target="_blank" class="underline text-blue-400">{{ att.displayName }}</a>
                        <button @click="markForDelete(att.id)" class="text-red-400">حذف</button>
                    </li>
                </ul>
            </div>
            <div v-if="form.newFiles.length">
                <p class="font-medium mt-4">فایل‌های جدید:</p>
                <ul class="space-y-2 mt-2">
                    <li v-for="(obj, i) in form.newFiles" :key="i" class="border border-gray-600 p-2 rounded flex justify-between items-center">
                        <span>{{ obj.file.name }}</span>
                        <button @click="removeNewFile(i)" class="text-red-400">×</button>
                    </li>
                </ul>
            </div>
            <input type="file" multiple @change="onFileChange" class="w-full mt-4" />
            <div class="flex justify-end space-x-2 mt-6">
              <button @click="closeForm" class="btn-secondary px-4 py-2">انصراف</button>
              <button @click="saveAnnouncement" class="btn-primary px-4 py-2">{{ editingId ? 'ذخیره' : 'ایجاد' }}</button>
            </div>
          </div>
        </div>
      </section>
      
      <section id="groups" class="content-section" :class="{'active fade-in': activeSection==='groups'}">
        <h2 class="text-2xl font-bold mb-4">مدیریت گروه‌ها</h2>
        <table class="min-w-full bg-gray-700 rounded overflow-hidden text-sm">
            <thead>
                <tr class="bg-gray-800 text-gray-300">
                  <th>#</th><th>نام گروه</th><th>کد</th><th>کیف پول</th><th>امتیاز</th><th>اعضا</th><th>سرگروه</th><th>ذخیره</th><th>حذف</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(g,idx) in groups" :key="g.id" class="border-b border-gray-600 hover:bg-gray-600">
                  <td class="px-2 py-1 text-center">{{ idx+1 }}</td>
                  <td class="px-2"><input v-model="g.name" class="input-field w-full text-sm"></td>
                  <td class="px-2"><input v-model="g.code" class="input-field w-full text-sm"></td>
                  <td class="px-2"><input v-model="g.walletCode" class="input-field w-full text-sm"></td>
                  <td class="px-2"><input type="number" v-model.number="g.score" class="input-field w-full text-sm"></td>
                  <td class="px-2 text-center">{{ g.members.length }}</td>
                  <td class="px-2">{{ g.leader ? `${g.leader.firstName} ${g.leader.lastName}` : 'نامشخص' }}</td>
                  <td class="px-2 text-center"><button class="btn-primary px-2 py-1 text-sm" @click="updateGroup(g)">ذخیره</button></td>
                  <td class="px-2 text-center"><button class="btn-secondary px-2 py-1 text-sm" @click="deleteGroup(g)">حذف</button></td>
                </tr>
              </tbody>
        </table>
      </section>

      <section id="items" class="content-section" :class="{'active fade-in': activeSection==='items'}">
        
        <div v-if="showCurrencyForm" class="modal-backdrop">
          <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">{{ editingId ? 'ویرایش ارز' : 'ایجاد ارز جدید' }}</h3>
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input v-model="currencyForm.name" placeholder="نام ارز (مثلا: سکه طلا)" class="input-field">
                <input v-model.number="currencyForm.basePrice" type="number" placeholder="قیمت پایه" class="input-field">
                <input v-model.number="currencyForm.priceCoefficient" type="number" step="0.001" placeholder="ضریب نوسان قیمت" class="input-field">
              </div>
              <textarea v-model="currencyForm.description" placeholder="توضیحات (اختیاری)" class="input-field w-full" rows="3"></textarea>
              <div>
                <label class="block mb-2 text-sm font-medium text-gray-300">عکس ارز</label>
                <div v-if="editingId && currencyForm.image" class="mb-2">
                    <img :src="currencyForm.image" alt="عکس فعلی" class="w-24 h-24 rounded-lg object-cover">
                </div>
                <input type="file" @change="handleFileSelect($event)" class="input-field w-full" accept="image/*">
                <p class="text-xs text-gray-400 mt-1">یک عکس جدید برای ایجاد یا جایگزینی عکس فعلی انتخاب کنید.</p>
              </div>
            </div>
            <div class="flex justify-end mt-6">
              <button @click="showCurrencyForm = false" class="btn-secondary ml-2 px-4 py-2">انصراف</button>
              <button @click="saveCurrency" class="btn-primary px-4 py-2">ذخیره</button>
            </div>
          </div>
        </div>

        <div v-if="showUniqueItemForm" class="modal-backdrop">
          <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">{{ editingId ? 'ویرایش آیتم خاص' : 'ایجاد آیتم خاص' }}</h3>
            <div class="space-y-4">
              <input v-model="uniqueItemForm.name" placeholder="نام آیتم خاص" class="input-field w-full">
              <input v-model.number="uniqueItemForm.purchasePrice" type="number" placeholder="قیمت خرید (امتیاز)" class="input-field w-full">
              <textarea v-model="uniqueItemForm.description" placeholder="توضیحات آیتم" class="input-field w-full" rows="3"></textarea>
              <div>
                <label class="block mb-2 text-sm font-medium text-gray-300">عکس آیتم</label>
                <div v-if="editingId && uniqueItemForm.image" class="mb-2">
                    <img :src="uniqueItemForm.image" alt="عکس فعلی" class="w-24 h-24 rounded-lg object-cover">
                </div>
                <input type="file" @change="handleUniqueItemFileSelect($event)" class="input-field w-full" accept="image/*">
              </div>
            </div>
            <div class="flex justify-end mt-6">
              <button @click="showUniqueItemForm = false" class="btn-secondary ml-2 px-4 py-2">انصراف</button>
              <button @click="saveUniqueItem" class="btn-primary px-4 py-2">ذخیره</button>
            </div>
          </div>
        </div>
      
        <div class="mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">مدیریت ارزها</h2>
            <button @click="openCreateCurrencyForm" class="btn-primary">ایجاد ارز جدید</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table w-full compact-table">
              <thead>
                <tr>
                  <th>عکس</th><th>نام ارز</th><th>قیمت پایه</th><th>ضریب نوسان</th><th>ضریب ادمین</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="c in currencies" :key="c.id">
                  <td><img :src="c.image || 'https://via.placeholder.com/40'" class="w-10 h-10 rounded-full object-cover"></td>
                  <td>{{ c.name }}</td>
                  <td>{{ c.basePrice }}</td>
                  <td>{{ c.priceCoefficient }}</td>
                  <td>{{ c.adminModifier }}</td>
                  <td>
                    <button @click="openEditCurrencyForm(c)" class="btn-secondary text-sm ml-1">ویرایش</button>
                    <button @click="applyModifier(c)" class="btn-primary text-sm ml-1">اعمال ضریب</button>
                    <button @click="deleteCurrency(c)" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm ml-1">حذف</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      
        <hr class="my-8 border-gray-600">

        <div>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">مدیریت آیتم‌های خاص</h2>
            <button @click="openCreateUniqueItemForm" class="btn-primary">ایجاد آیتم جدید</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table w-full compact-table">
              <thead>
                <tr>
                  <th>عکس</th><th>نام آیتم</th><th>شناسه یکتا</th><th>قیمت خرید</th><th>وضعیت</th><th>مالک</th><th>عملیات</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in unique_items" :key="item.id">
                  <td><img :src="item.image || 'https://via.placeholder.com/40'" class="w-10 h-10 rounded-full object-cover"></td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.uniqueIdentifier }}</td>
                  <td>{{ item.purchasePrice }}</td>
                  <td>
                    <span :class="item.status === 'in_shop' ? 'text-green-400' : 'text-yellow-400'">
                        {{ item.status === 'in_shop' ? 'در فروشگاه' : 'فروخته شده' }}
                    </span>
                  </td>
                  <td>{{ item.owner ? item.owner.name : '—' }}</td>
                  <td>
                    <button @click="openEditUniqueItemForm(item)" class="btn-secondary text-sm ml-1">ویرایش</button>
                    <button @click="deleteUniqueItem(item)" v-if="item.status === 'in_shop'" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm ml-1">حذف</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </section>

      <section id="contents" class="content-section" :class="{'active fade-in': activeSection==='contents'}">
        <h2 class="text-2xl font-bold mb-4">مدیریت محتواها</h2>
        <button @click="openCreateContentForm" class="btn-primary px-4 py-2 mb-4">ایجاد محتوای جدید</button>
        <table class="min-w-full bg-gray-700 rounded overflow-hidden text-sm">
          <thead class="bg-gray-800 text-gray-300">
              <tr>
                <th class="px-2 py-1">#</th><th class="px-2 py-1">عنوان</th><th class="px-2 py-1">مختصر</th><th class="px-2 py-1">تاریخ</th><th class="px-2 py-1">فایل‌ها</th><th class="px-2 py-1">ویرایش</th><th class="px-2 py-1">حذف</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(c, idx) in training" :key="c.id" class="border-b border-gray-600 hover:bg-gray-600">
                <td class="px-2 py-1 text-center">{{ idx+1 }}</td>
                <td class="px-2">{{ c.title }}</td>
                <td class="px-2">{{ c.shortDescription||'—' }}</td>
                <td class="px-2">{{ new Date(c.createdAt).toLocaleDateString('fa-IR') }}</td>
                <td class="px-2">
                  <ul class="list-disc list-inside">
                    <li v-for="att in c.attachments" :key="att.id">
                      <a :href="att.path" target="_blank" class="underline text-blue-400">{{ att.originalName }}</a>
                    </li>
                  </ul>
                </td>
                <td class="px-2 text-center">
                  <button @click="openEditContentForm(c)" class="btn-secondary px-2 py-1 text-sm">ویرایش</button>
                </td>
                <td class="px-2 text-center">
                  <button @click="deleteContent(c)" class="btn-primary px-2 py-1 text-sm">حذف</button>
                </td>
              </tr>
            </tbody>
        </table>

        <div v-if="showContentForm" class="modal-backdrop">
            <div class="modal-content">
                <h3 class="text-xl font-bold">{{ editingContentId ? 'ویرایش محتوا' : 'ایجاد محتوا جدید' }}</h3>
                <input v-model="contentForm.title" placeholder="عنوان *" class="input-field w-full mt-4" />
                <input v-model="contentForm.shortDescription" placeholder="مختصر" class="input-field w-full mt-2" />
                <textarea v-model="contentForm.longDescription" placeholder="توضیح کامل" class="input-field w-full h-24 mt-2"></textarea>
                <div v-if="contentForm.attachments.length">
                    <p class="font-medium mt-4">ضمائم فعلی:</p>
                    <ul class="space-y-2 mt-2">
                        <li v-for="att in contentForm.attachments" :key="att.id" class="border border-gray-600 p-2 rounded flex justify-between items-center">
                            <a :href="att.path" target="_blank" class="underline text-blue-400">{{ att.displayName }}</a>
                            <button @click="markContentForDelete(att.id)" class="text-red-400">حذف</button>
                        </li>
                    </ul>
                </div>
                <input type="file" multiple @change="handleContentFiles" class="w-full mt-4"/>
                <div class="flex justify-end space-x-2 mt-6">
                    <button @click="showContentForm=false" class="btn-secondary px-4 py-2">انصراف</button>
                    <button @click="saveContent" class="btn-primary px-4 py-2">ذخیره</button>
                </div>
            </div>
        </div>
      </section>

      <section id="features" class="content-section" :class="{'active fade-in': activeSection==='features'}">
        <h2 class="text-2xl font-bold text-white mb-6">مدیریت رویدادها و قابلیت‌ها</h2>
      
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
          
          <div class="mb-8">
            <h3 class="text-xl font-semibold text-cyan-400 border-b-2 border-cyan-500 pb-2 mb-4">
              کنترل دسترسی به منوها
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <div v-for="flag in menuFlags" :key="flag.name" 
                   class="bg-gray-700 p-4 rounded-lg flex items-center justify-between shadow">
                <label :for="'toggle-' + flag.name" class="text-gray-200 text-sm font-medium">
                  {{ flag.displayName }}
                </label>
                <input type="checkbox" :id="'toggle-' + flag.name" class="w-6 h-6" 
                       v-model="flag.isEnabled">
              </div>
            </div>
          </div>
      
          <div class="mb-8">
            <h3 class="text-xl font-semibold text-amber-400 border-b-2 border-amber-500 pb-2 mb-4">
              کنترل عملیات‌های حساس
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              <div v-for="flag in actionFlags" :key="flag.name" 
                   class="bg-gray-700 p-4 rounded-lg flex items-center justify-between shadow">
                <label :for="'toggle-' + flag.name" class="text-gray-200 text-sm font-medium">
                  {{ flag.displayName }}
                </label>
                <input type="checkbox" :id="'toggle-' + flag.name" class="w-6 h-6" 
                       v-model="flag.isEnabled">
              </div>
            </div>
          </div>
      
          <div class="flex justify-end mt-6">
            <button @click="saveFeatureFlags" 
                    class="btn-primary text-white font-bold py-2 px-6 rounded-lg
                           hover:bg-green-600 transition duration-300">
              ذخیره تغییرات
            </button>
          </div>
      
        </div>
      </section>
      

    </div>
  </div>
  
  <script src="/js/socket-manager.js"></script>
  <script src="/js/admin-users-mixin.js"></script>
  <script src="/js/admin-announcements-mixin.js"></script>
  <script src="/js/admin-groups-mixin.js"></script>
  <script src="/js/admin-contents-mixin.js"></script>
  <script src="/js/admin-shop-mixin.js"></script>
  <script src="/js/admin-unique-items-mixin.js"></script>
  <script src="/js/admin-features-mixin.js"></script>
  <script src="/js/admin.js"></script>

</body>
</html>
